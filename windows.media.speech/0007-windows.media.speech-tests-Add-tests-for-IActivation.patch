From 75ec64efd35fd31967487f73b5c4713f2cfc81fd Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Bernhard=20K=C3=B6lbl?= <besentv@gmail.com>
Date: Thu, 27 Jan 2022 23:52:32 +0100
Subject: [PATCH 07/14] windows.media.speech/tests: Add tests for
 IActivationFactory.

---
 dlls/windows.media.speech/tests/speech.c | 54 ++++++++++++++++++++++++
 1 file changed, 54 insertions(+)

diff --git a/dlls/windows.media.speech/tests/speech.c b/dlls/windows.media.speech/tests/speech.c
index 38fd5c90dd0..2c7aa9db60f 100644
--- a/dlls/windows.media.speech/tests/speech.c
+++ b/dlls/windows.media.speech/tests/speech.c
@@ -29,6 +29,8 @@
 #define WIDL_using_Windows_Foundation
 #define WIDL_using_Windows_Foundation_Collections
 #include "windows.foundation.h"
+#define WIDL_using_Windows_Media_SpeechRecognition
+#include "windows.media.speechrecognition.h"
 #define WIDL_using_Windows_Media_SpeechSynthesis
 #include "windows.media.speechsynthesis.h"
 
@@ -36,6 +38,57 @@
 
 HRESULT WINAPI (*pDllGetActivationFactory)(HSTRING, IActivationFactory **);
 
+static void test_ActivationFactory(void)
+{
+    static const WCHAR *speech_synthesizer_name = L"Windows.Media.SpeechSynthesis.SpeechSynthesizer";
+    static const WCHAR *speech_recognition_grammar_file_constraint_name = L"Windows.Media.SpeechRecognition.SpeechRecognitionGrammarFileConstraint";
+    IActivationFactory *factory = NULL, *factory2 = NULL, *factory3 = NULL;
+    ISpeechRecognitionListConstraintFactory* srlc_factory = NULL;
+    ISpeechRecognizerFactory* sr_factory = NULL;
+    HSTRING str;
+    HRESULT hr;
+    ULONG ref;
+
+    hr = RoInitialize(RO_INIT_MULTITHREADED);
+    ok(hr == S_OK, "RoInitialize failed, hr %#x\n", hr);
+
+    hr = WindowsCreateString(speech_synthesizer_name, wcslen(speech_synthesizer_name), &str);
+    ok(hr == S_OK, "WindowsCreateString failed, hr %#x\n", hr);
+
+    hr = RoGetActivationFactory(str, &IID_IActivationFactory, (void **)&factory);
+    ok(hr == S_OK, "RoGetActivationFactory failed, hr %#x\n", hr);
+
+    hr = IActivationFactory_QueryInterface(factory, &IID_ISpeechRecognizerFactory, (void**)&sr_factory);
+    ok(hr == S_OK, "IActivationFactory_QueryInterface failed, hr %#x\n", hr);
+
+    if(sr_factory)
+    {
+        ref = ISpeechRecognizerFactory_Release(sr_factory);
+        ok(ref == 1, "Got unexpected refcount: %u\n", ref);
+    }
+
+    hr = RoGetActivationFactory(str, &IID_IActivationFactory, (void **)&factory2);
+    ok(hr == S_OK, "RoGetActivationFactory failed, hr %#x\n", hr);
+
+    ok(factory == factory2, "Factories didn't point at the same memory!");
+
+    hr = RoGetActivationFactory(str, &IID_IActivationFactory, (void **)&factory3);
+    ok(hr == S_OK, "RoGetActivationFactory failed, hr %#x\n", hr);
+
+    ref = IActivationFactory_Release(factory3);
+    ok(ref == 0, "Got unexpected refcount: %u\n", ref);
+
+    ref = IActivationFactory_Release(factory2);
+    ok(ref == 0, "Got unexpected refcount: %u\n", ref);
+
+    ref = IActivationFactory_Release(factory);
+    ok(ref == 0, "Got unexpected refcount: %u\n", ref);
+
+    WindowsDeleteString(str);
+
+    RoUninitialize();
+}
+
 static void test_SpeechSynthesizer(void)
 {
     static const WCHAR *speech_synthesizer_name = L"Windows.Media.SpeechSynthesis.SpeechSynthesizer";
@@ -203,6 +256,7 @@ static void test_VoiceInformation(void)
 
 START_TEST(speech)
 {
+    test_ActivationFactory();
     test_SpeechSynthesizer();
     test_VoiceInformation();
 }
-- 
2.34.1

