From 473f3cab221ff0bab57206482c0f97bc7016cff7 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Bernhard=20K=C3=B6lbl?= <besentv@gmail.com>
Date: Mon, 7 Feb 2022 23:10:55 +0100
Subject: [PATCH v2 47/49] windows.media.speech: Implement
 ISpeechRecognitionResult_get_Text.

---
 .../speechrecognitionresult.c                    | 16 +++++++++++++---
 .../windows_media_speech_private.h               |  2 +-
 2 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/dlls/windows.media.speech/speechrecognitionresult.c b/dlls/windows.media.speech/speechrecognitionresult.c
index 9ffd262dad8..4519ade1ac9 100644
--- a/dlls/windows.media.speech/speechrecognitionresult.c
+++ b/dlls/windows.media.speech/speechrecognitionresult.c
@@ -299,6 +299,8 @@ struct speech_recognition_result
     ISpeechRecognitionResult ISpeechRecognitionResult_iface;
     ISpeechRecognitionResult2 ISpeechRecognitionResult2_iface;
     LONG ref;
+
+    HSTRING text;
 };
 
 /*
@@ -357,7 +359,10 @@ static ULONG STDMETHODCALLTYPE speech_recognition_result_Release(ISpeechRecognit
     TRACE("iface %p, ref %u.\n", iface, ref);
 
     if(!ref)
+    {
+        WindowsDeleteString(impl->text);
         heap_free(impl);
+    }
 
     return ref;
 }
@@ -390,8 +395,11 @@ static HRESULT STDMETHODCALLTYPE speech_recognition_result_get_Status(
 static HRESULT STDMETHODCALLTYPE speech_recognition_result_get_Text(
     ISpeechRecognitionResult *iface, HSTRING *value)
 {
-    FIXME("iface %p, operation %p stub!\n", iface, value);
-    return E_NOTIMPL;
+    struct speech_recognition_result *impl = impl_from_ISpeechRecognitionResult(iface);
+
+    TRACE("iface %p, operation %p.\n", iface, value);
+
+    return WindowsDuplicateString(impl->text, value);
 }
 
 static HRESULT STDMETHODCALLTYPE speech_recognition_result_get_Confidence(
@@ -555,7 +563,7 @@ static const struct ISpeechRecognitionResult2Vtbl speech_recognition_result2_vtb
     speech_recognition_result2_get_PhraseDuration
 };
 
-HRESULT STDMETHODCALLTYPE speech_recognition_result_create(ISpeechRecognitionResult **out)
+HRESULT STDMETHODCALLTYPE speech_recognition_result_create(HSTRING text, ISpeechRecognitionResult **out)
 {
     struct speech_recognition_result *impl;
 
@@ -571,6 +579,8 @@ HRESULT STDMETHODCALLTYPE speech_recognition_result_create(ISpeechRecognitionRes
     impl->ISpeechRecognitionResult2_iface.lpVtbl = &speech_recognition_result2_vtbl;
     impl->ref = 1;
 
+    impl->text = text;
+
     *out = &impl->ISpeechRecognitionResult_iface;
     return S_OK;
 }
diff --git a/dlls/windows.media.speech/windows_media_speech_private.h b/dlls/windows.media.speech/windows_media_speech_private.h
index ca13d967a8c..c995a5f55b9 100644
--- a/dlls/windows.media.speech/windows_media_speech_private.h
+++ b/dlls/windows.media.speech/windows_media_speech_private.h
@@ -69,7 +69,7 @@ void STDMETHODCALLTYPE speech_recognition_list_constraint_get_activation_factory
 void STDMETHODCALLTYPE speech_recognizer_get_activation_factory(IActivationFactory **factory) DECLSPEC_HIDDEN;
 
 HRESULT STDMETHODCALLTYPE speech_continuous_recognition_session_create(ISpeechContinuousRecognitionSession **out) DECLSPEC_HIDDEN;
-HRESULT STDMETHODCALLTYPE speech_recognition_result_create(ISpeechRecognitionResult **out) DECLSPEC_HIDDEN;
+HRESULT STDMETHODCALLTYPE speech_recognition_result_create(HSTRING text, ISpeechRecognitionResult **out) DECLSPEC_HIDDEN;
 HRESULT STDMETHODCALLTYPE speech_recognizer_state_changed_event_args_create_from_iid(REFIID iid, void **obj) DECLSPEC_HIDDEN;
 
 /*
-- 
2.35.1

