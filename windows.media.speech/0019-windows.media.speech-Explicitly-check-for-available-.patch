From b378bd46f10c2f7b3c0e4bf8cd7a4c6449a1b699 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Bernhard=20K=C3=B6lbl?= <besentv@gmail.com>
Date: Sun, 30 Jan 2022 22:13:03 +0100
Subject: [PATCH 19/27] windows.media.speech: Explicitly check for available
 activation factory.

---
 dlls/windows.media.speech/main.c                    | 13 +++++++------
 .../windows_media_speech_private.h                  |  2 ++
 2 files changed, 9 insertions(+), 6 deletions(-)

diff --git a/dlls/windows.media.speech/main.c b/dlls/windows.media.speech/main.c
index 13a497151e3..f275840e965 100644
--- a/dlls/windows.media.speech/main.c
+++ b/dlls/windows.media.speech/main.c
@@ -33,13 +33,14 @@ HRESULT WINAPI DllGetActivationFactory(HSTRING classid, IActivationFactory **fac
 {
     TRACE("classid %s, factory %p.\n", debugstr_hstring(classid), factory);
 
-    if (wcscmp(WindowsGetStringRawBuffer(classid, NULL), L"Windows.Media.SpeechSynthesis.SpeechSynthesizer"))
+    if (IsEqualClassID(WindowsGetStringRawBuffer(classid, NULL),
+        L"Windows.Media.SpeechSynthesis.SpeechSynthesizer"))
     {
-        ERR("Unknown classid %s.\n", debugstr_hstring(classid));
-        return CLASS_E_CLASSNOTAVAILABLE;
+        speech_synthesizer_get_activation_factory(factory);
+        IUnknown_AddRef(*factory);
+        return S_OK;
     }
 
-    speech_synthesizer_get_activation_factory(factory);
-    IUnknown_AddRef(*factory);
-    return S_OK;
+    ERR("Unknown classid %s.\n", debugstr_hstring(classid));
+    return CLASS_E_CLASSNOTAVAILABLE;
 }
diff --git a/dlls/windows.media.speech/windows_media_speech_private.h b/dlls/windows.media.speech/windows_media_speech_private.h
index 020e5f142b6..441d95b3e5d 100644
--- a/dlls/windows.media.speech/windows_media_speech_private.h
+++ b/dlls/windows.media.speech/windows_media_speech_private.h
@@ -45,6 +45,8 @@
 #define WIDL_using_Windows_Media_SpeechSynthesis
 #include "windows.media.speechsynthesis.h"
 
+#define IsEqualClassID(classid1, classid2) (!wcscmp(classid1, classid2))
+
 static inline const char *debugstr_hstring(HSTRING hstr)
 {
     const WCHAR *str;
-- 
2.34.1

