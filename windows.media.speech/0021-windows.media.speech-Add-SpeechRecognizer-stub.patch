From 302d90fb34ec1a898e0a22aa792b1a190c4c0e99 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Bernhard=20K=C3=B6lbl?= <besentv@gmail.com>
Date: Sun, 30 Jan 2022 14:53:49 +0100
Subject: [PATCH v2 21/28] windows.media.speech: Add SpeechRecognizer stub.

---
v2: Add missing SpeechRecognizerStatics and move the activation
factory from main.c .
---
 dlls/windows.media.speech/Makefile.in         |   1 +
 dlls/windows.media.speech/classes.idl         |   1 +
 dlls/windows.media.speech/main.c              |   7 +
 dlls/windows.media.speech/speechrecognizer.c  | 949 ++++++++++++++++++
 dlls/windows.media.speech/tests/speech.c      | 121 ++-
 .../windows_media_speech_private.h            |  10 +
 6 files changed, 1088 insertions(+), 1 deletion(-)
 create mode 100644 dlls/windows.media.speech/speechrecognizer.c

diff --git a/dlls/windows.media.speech/Makefile.in b/dlls/windows.media.speech/Makefile.in
index 4f15b674d8e..8a9b5b2cf7d 100644
--- a/dlls/windows.media.speech/Makefile.in
+++ b/dlls/windows.media.speech/Makefile.in
@@ -4,6 +4,7 @@ IMPORTS = combase uuid
 
 C_SRCS = \
 	main.c \
+	speechrecognizer.c \
 	speechsynthesizer.c
 
 IDL_SRCS = classes.idl
diff --git a/dlls/windows.media.speech/classes.idl b/dlls/windows.media.speech/classes.idl
index 6c141bf4768..4dd43cf6eed 100644
--- a/dlls/windows.media.speech/classes.idl
+++ b/dlls/windows.media.speech/classes.idl
@@ -16,4 +16,5 @@
 
 #pragma makedep register
 
+#include "windows.media.speechrecognition.idl"
 #include "windows.media.speechsynthesis.idl"
diff --git a/dlls/windows.media.speech/main.c b/dlls/windows.media.speech/main.c
index f275840e965..072c6ba314b 100644
--- a/dlls/windows.media.speech/main.c
+++ b/dlls/windows.media.speech/main.c
@@ -40,6 +40,13 @@ HRESULT WINAPI DllGetActivationFactory(HSTRING classid, IActivationFactory **fac
         IUnknown_AddRef(*factory);
         return S_OK;
     }
+    else if (IsEqualClassID(WindowsGetStringRawBuffer(classid, NULL),
+        L"Windows.Media.SpeechRecognition.SpeechRecognizer"))
+    {
+        speech_recognizer_get_activation_factory(factory);
+        IUnknown_AddRef(*factory);
+        return S_OK;
+    }
 
     ERR("Unknown classid %s.\n", debugstr_hstring(classid));
     return CLASS_E_CLASSNOTAVAILABLE;
diff --git a/dlls/windows.media.speech/speechrecognizer.c b/dlls/windows.media.speech/speechrecognizer.c
new file mode 100644
index 00000000000..2a150005703
--- /dev/null
+++ b/dlls/windows.media.speech/speechrecognizer.c
@@ -0,0 +1,949 @@
+/* WinRT Windows.Media.SpeechRecognition implementation
+ *
+ * Copyright 2022 Bernhard KÃ¶lbl
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Lesser General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Lesser General Public License for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public
+ * License along with this library; if not, write to the Free Software
+ * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA
+ */
+
+#include "windows_media_speech_private.h"
+
+WINE_DEFAULT_DEBUG_CHANNEL(speech);
+
+/*
+ *
+ * SpeechRecognizer
+ *
+ */
+
+struct speech_recognizer
+{
+    ISpeechRecognizer ISpeechRecognizer_iface;
+    IClosable IClosable_iface;
+    ISpeechRecognizer2 ISpeechRecognizer2_iface;
+    LONG ref;
+};
+
+/*
+ *
+ * ISpeechRecognizer
+ *
+ */
+
+static inline struct speech_recognizer *impl_from_ISpeechRecognizer(ISpeechRecognizer *iface)
+{
+    return CONTAINING_RECORD(iface, struct speech_recognizer, ISpeechRecognizer_iface);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_QueryInterface(ISpeechRecognizer *iface, REFIID iid, void **out)
+{
+    struct speech_recognizer *impl = impl_from_ISpeechRecognizer(iface);
+
+    TRACE("iface %p, iid %s, out %p.\n", iface, debugstr_guid(iid), out);
+
+    if (IsEqualGUID(iid, &IID_IUnknown) ||
+        IsEqualGUID(iid, &IID_IInspectable) ||
+        IsEqualGUID(iid, &IID_ISpeechRecognizer))
+    {
+        IUnknown_AddRef(iface);
+        *out = iface;
+        return S_OK;
+    }
+
+    if(IsEqualGUID(iid, &IID_IClosable))
+    {
+        IUnknown_AddRef(iface);
+        *out = &impl->IClosable_iface;
+        return S_OK;
+    }
+
+    if(IsEqualGUID(iid, &IID_ISpeechRecognizer2))
+    {
+        IUnknown_AddRef(iface);
+        *out = &impl->ISpeechRecognizer2_iface;
+        return S_OK;
+    }
+
+    WARN("%s not implemented, returning E_NOINTERFACE.\n", debugstr_guid(iid));
+    *out = NULL;
+    return E_NOINTERFACE;
+}
+
+static ULONG STDMETHODCALLTYPE speech_recognizer_AddRef(ISpeechRecognizer *iface)
+{
+    struct speech_recognizer *impl = impl_from_ISpeechRecognizer(iface);
+
+    ULONG ref = InterlockedIncrement(&impl->ref);
+    TRACE("iface %p, ref %u.\n", iface, ref);
+
+    return ref;
+}
+
+static ULONG STDMETHODCALLTYPE speech_recognizer_Release(ISpeechRecognizer *iface)
+{
+    struct speech_recognizer *impl = impl_from_ISpeechRecognizer(iface);
+
+    ULONG ref = InterlockedDecrement(&impl->ref);
+    TRACE("iface %p, ref %u.\n", iface, ref);
+
+    if(!ref)
+        free(impl);
+
+    return ref;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_GetIids(ISpeechRecognizer *iface, ULONG *iid_count, IID **iids)
+{
+    FIXME("iface %p, iid_count %p, iids %p stub!\n", iface, iid_count, iids);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_GetRuntimeClassName(ISpeechRecognizer *iface, HSTRING *class_name)
+{
+    FIXME("iface %p, class_name %p stub!\n", iface, class_name);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_GetTrustLevel(ISpeechRecognizer *iface, TrustLevel *trust_level)
+{
+    FIXME("iface %p, trust_level %p stub!\n", iface, trust_level);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_get_Constraints(ISpeechRecognizer *iface,
+    IVector_ISpeechRecognitionConstraint **vector)
+{
+    FIXME("iface %p, operation %p stub!\n", iface, vector);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_get_CurrentLanguage(ISpeechRecognizer *iface,
+    ILanguage **language)
+{
+    FIXME("iface %p, operation %p stub!\n", iface, language);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_get_Timeouts(ISpeechRecognizer *iface,
+    ISpeechRecognizerTimeouts **timeouts)
+{
+    FIXME("iface %p, operation %p stub!\n", iface, timeouts);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_get_UIOptions(ISpeechRecognizer *iface,
+    ISpeechRecognizerUIOptions **options)
+{
+    FIXME("iface %p, operation %p stub!\n", iface, options);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_CompileConstraintsAsync(ISpeechRecognizer *iface,
+    IAsyncOperation_SpeechRecognitionCompilationResult **operation)
+{
+    FIXME("iface %p, operation %p stub!\n", iface, operation);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_RecognizeAsync(ISpeechRecognizer *iface,
+    IAsyncOperation_SpeechRecognitionResult **operation)
+{
+    FIXME("iface %p, operation %p stub!\n", iface, operation);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_RecognizeWithUIAsync(ISpeechRecognizer *iface,
+    IAsyncOperation_SpeechRecognitionResult **operation)
+{
+    FIXME("iface %p, operation %p stub!\n", iface, operation);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_add_RecognitionQualityDegrading(ISpeechRecognizer *iface,
+    ITypedEventHandler_SpeechRecognizer_SpeechRecognitionQualityDegradingEventArgs *handler, EventRegistrationToken *token)
+{
+    FIXME("iface %p, operation %p, token %p, stub!\n", iface, handler, token);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_remove_RecognitionQualityDegrading(
+    ISpeechRecognizer *iface, EventRegistrationToken token)
+{
+    FIXME("iface %p, token.value %#I64x, stub!\n", iface, token.value);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_add_StateChanged(ISpeechRecognizer *iface,
+    ITypedEventHandler_SpeechRecognizer_SpeechRecognizerStateChangedEventArgs *handler, EventRegistrationToken *token)
+{
+    FIXME("iface %p, operation %p, token %p, stub!\n", iface, handler, token);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_remove_StateChanged(
+    ISpeechRecognizer *iface, EventRegistrationToken token)
+{
+    FIXME("iface %p, token.value %#I64x, stub!\n", iface, token.value);
+    return E_NOTIMPL;
+}
+
+static const struct ISpeechRecognizerVtbl speech_recognizer_vtbl =
+{
+    /* IUnknown methods */
+    speech_recognizer_QueryInterface,
+    speech_recognizer_AddRef,
+    speech_recognizer_Release,
+    /* IInspectable methods */
+    speech_recognizer_GetIids,
+    speech_recognizer_GetRuntimeClassName,
+    speech_recognizer_GetTrustLevel,
+    /* ISpeechRecognizer methods */
+    speech_recognizer_get_CurrentLanguage,
+    speech_recognizer_get_Constraints,
+    speech_recognizer_get_Timeouts,
+    speech_recognizer_get_UIOptions,
+    speech_recognizer_CompileConstraintsAsync,
+    speech_recognizer_RecognizeAsync,
+    speech_recognizer_RecognizeWithUIAsync,
+    speech_recognizer_add_RecognitionQualityDegrading,
+    speech_recognizer_remove_RecognitionQualityDegrading,
+    speech_recognizer_add_StateChanged,
+    speech_recognizer_remove_StateChanged,
+};
+
+/*
+ *
+ * IClosable
+ *
+ */
+
+static inline struct speech_recognizer *impl_from_IClosable(IClosable *iface)
+{
+    return CONTAINING_RECORD(iface, struct speech_recognizer, IClosable_iface);
+}
+
+static HRESULT STDMETHODCALLTYPE closable_QueryInterface(
+    IClosable *iface, REFIID iid, void **out)
+{
+    struct speech_recognizer *impl = impl_from_IClosable(iface);
+
+    TRACE("iface %p, iid %s, out %p.\n", iface, debugstr_guid(iid), out);
+
+    /* IUnknown_QueryInterface already defined by ISpeechRecognizer_iface. Redirect there. */
+    return ISpeechRecognizer_QueryInterface(&impl->ISpeechRecognizer_iface, iid, out);
+}
+
+static ULONG STDMETHODCALLTYPE closable_AddRef(
+    IClosable *iface)
+{
+    struct speech_recognizer *impl = impl_from_IClosable(iface);
+
+    TRACE("iface %p.\n", iface);
+
+    /* IUnknown_AddRef already defined by ISpeechRecognizer_iface. Redirect there. */
+    return ISpeechRecognizer_AddRef(&impl->ISpeechRecognizer_iface);
+}
+
+static ULONG STDMETHODCALLTYPE closable_Release(
+    IClosable *iface)
+{
+    struct speech_recognizer *impl = impl_from_IClosable(iface);
+
+    TRACE("iface %p.\n", iface);
+
+    /* IUnknown_Release already defined by ISpeechRecognizer_iface. Redirect there. */
+    return ISpeechRecognizer_Release(&impl->ISpeechRecognizer_iface);
+}
+
+static HRESULT STDMETHODCALLTYPE closable_GetIids(
+    IClosable *iface, ULONG *iid_count, IID **iids)
+{
+    struct speech_recognizer *impl = impl_from_IClosable(iface);
+
+    TRACE("iface %p, iid_count %p, iids %p.\n", iface, iid_count, iids);
+
+    /* IInspectable_GetIids already defined by ISpeechRecognizer_iface. Redirect there. */
+    return ISpeechRecognizer_GetIids(&impl->ISpeechRecognizer_iface, iid_count, iids);
+}
+
+static HRESULT STDMETHODCALLTYPE closable_GetRuntimeClassName(
+    IClosable *iface, HSTRING *class_name)
+{
+    struct speech_recognizer *impl = impl_from_IClosable(iface);
+
+    TRACE("iface %p, class_name %p.\n", iface, class_name);
+
+    /* IInspectable_GetRuntimeClassName already defined by ISpeechRecognizer_iface. Redirect there. */
+    return ISpeechRecognizer_GetRuntimeClassName(&impl->ISpeechRecognizer_iface, class_name);
+}
+
+static HRESULT STDMETHODCALLTYPE closable_GetTrustLevel(
+    IClosable *iface, TrustLevel *trust_level)
+{
+    struct speech_recognizer *impl = impl_from_IClosable(iface);
+
+    TRACE("iface %p, trust_level %p.\n", iface, trust_level);
+
+    /* IInspectable_GetTrustLevel already defined by ISpeechRecognizer_iface. Redirect there. */
+    return ISpeechRecognizer_GetTrustLevel(&impl->ISpeechRecognizer_iface, trust_level);
+}
+
+static HRESULT STDMETHODCALLTYPE closable_Close(
+    IClosable *iface)
+{
+    FIXME("iface %p stub.\n", iface);
+    return E_NOTIMPL;
+}
+
+static const struct IClosableVtbl closable_vtbl =
+{
+    /* IUnknown methods */
+    closable_QueryInterface,
+    closable_AddRef,
+    closable_Release,
+    /* IInspectable methods */
+    closable_GetIids,
+    closable_GetRuntimeClassName,
+    closable_GetTrustLevel,
+    /* IClosable methods */
+    closable_Close,
+};
+
+/*
+ *
+ * ISpeechRecognizer2
+ *
+ */
+
+static inline struct speech_recognizer *impl_from_ISpeechRecognizer2(ISpeechRecognizer2 *iface)
+{
+    return CONTAINING_RECORD(iface, struct speech_recognizer, ISpeechRecognizer2_iface);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer2_QueryInterface(ISpeechRecognizer2 *iface, REFIID iid, void **out)
+{
+    struct speech_recognizer *impl = impl_from_ISpeechRecognizer2(iface);
+
+    TRACE("iface %p, iid %s, out %p.\n", iface, debugstr_guid(iid), out);
+
+    /* IUnknown_QueryInterface already defined by ISpeechRecognizer_iface. Redirect there. */
+    return ISpeechRecognizer_QueryInterface(&impl->ISpeechRecognizer_iface, iid, out);
+}
+
+static ULONG STDMETHODCALLTYPE speech_recognizer2_AddRef(ISpeechRecognizer2 *iface)
+{
+    struct speech_recognizer *impl = impl_from_ISpeechRecognizer2(iface);
+
+    TRACE("iface %p.\n", iface);
+
+    /* IUnknown_AddRef already defined by ISpeechRecognizer_iface. Redirect there. */
+    return ISpeechRecognizer_AddRef(&impl->ISpeechRecognizer_iface);
+}
+
+static ULONG STDMETHODCALLTYPE speech_recognizer2_Release(ISpeechRecognizer2 *iface)
+{
+    struct speech_recognizer *impl = impl_from_ISpeechRecognizer2(iface);
+
+    TRACE("iface %p.\n", iface);
+
+    /* IUnknown_Release already defined by ISpeechRecognizer_iface. Redirect there. */
+    return ISpeechRecognizer_Release(&impl->ISpeechRecognizer_iface);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer2_GetIids(ISpeechRecognizer2 *iface, ULONG *iid_count, IID **iids)
+{
+    struct speech_recognizer *impl = impl_from_ISpeechRecognizer2(iface);
+
+    TRACE("iface %p, iid_count %p, iids %p.\n", iface, iid_count, iids);
+
+    /* IInspectable_GetIids already defined by ISpeechRecognizer_iface. Redirect there. */
+    return ISpeechRecognizer_GetIids(&impl->ISpeechRecognizer_iface, iid_count, iids);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer2_GetRuntimeClassName(ISpeechRecognizer2 *iface, HSTRING *class_name)
+{
+    struct speech_recognizer *impl = impl_from_ISpeechRecognizer2(iface);
+
+    TRACE("iface %p, class_name %p.\n", iface, class_name);
+
+    /* IInspectable_GetRuntimeClassName already defined by ISpeechRecognizer_iface. Redirect there. */
+    return ISpeechRecognizer_GetRuntimeClassName(&impl->ISpeechRecognizer_iface, class_name);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer2_GetTrustLevel(ISpeechRecognizer2 *iface, TrustLevel *trust_level)
+{
+    struct speech_recognizer *impl = impl_from_ISpeechRecognizer2(iface);
+
+    TRACE("iface %p, trust_level %p.\n", iface, trust_level);
+
+    /* IInspectable_GetTrustLevel already defined by ISpeechRecognizer_iface. Redirect there. */
+    return ISpeechRecognizer_GetTrustLevel(&impl->ISpeechRecognizer_iface, trust_level);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer2_get_ContinuousRecognitionSession(ISpeechRecognizer2 *iface,
+    ISpeechContinuousRecognitionSession **session)
+{
+    FIXME("iface %p, session %p stub!\n", iface, session);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer2_get_State(ISpeechRecognizer2 *iface,
+    SpeechRecognizerState *state)
+{
+    FIXME("iface %p, state %p stub!\n", iface, state);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer2_StopRecognitionAsync(ISpeechRecognizer2 *iface,
+    IAsyncAction **action)
+{
+    FIXME("iface %p, action %p stub!\n", iface, action);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer2_add_HypothesisGenerated(ISpeechRecognizer2 *iface,
+    ITypedEventHandler_SpeechRecognizer_SpeechRecognitionHypothesisGeneratedEventArgs *handler, EventRegistrationToken *token)
+{
+    FIXME("iface %p, operation %p, token %p, stub!\n", iface, handler, token);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer2_remove_HypothesisGenerated(
+    ISpeechRecognizer2 *iface, EventRegistrationToken token)
+{
+    FIXME("iface %p, token.value %#I64x, stub!\n", iface, token.value);
+    return E_NOTIMPL;
+}
+
+static const struct ISpeechRecognizer2Vtbl speech_recognizer2_vtbl =
+{
+    /* IUnknown methods */
+    speech_recognizer2_QueryInterface,
+    speech_recognizer2_AddRef,
+    speech_recognizer2_Release,
+    /* IInspectable methods */
+    speech_recognizer2_GetIids,
+    speech_recognizer2_GetRuntimeClassName,
+    speech_recognizer2_GetTrustLevel,
+    /* ISpeechRecognizer2 methods */
+    speech_recognizer2_get_ContinuousRecognitionSession,
+    speech_recognizer2_get_State,
+    speech_recognizer2_StopRecognitionAsync,
+    speech_recognizer2_add_HypothesisGenerated,
+    speech_recognizer2_remove_HypothesisGenerated,
+};
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_create(ILanguage *language, ISpeechRecognizer **speechrecognizer)
+{
+    struct speech_recognizer *impl;
+    HRESULT hr;
+
+    TRACE("language %p, speechrecognizer %p stub!\n", language, speechrecognizer);
+
+    if (!(impl = calloc(1, sizeof(*impl))))
+    {
+        *speechrecognizer = NULL;
+        return E_OUTOFMEMORY;
+    }
+
+    if(language)
+        FIXME("ILanguage parameter not used. Stub!\n");
+
+    impl->ISpeechRecognizer_iface.lpVtbl = &speech_recognizer_vtbl;
+    impl->IClosable_iface.lpVtbl = &closable_vtbl;
+    impl->ISpeechRecognizer2_iface.lpVtbl = &speech_recognizer2_vtbl;
+    impl->ref = 1;
+
+    hr = ISpeechRecognizer_QueryInterface(&impl->ISpeechRecognizer_iface, &IID_ISpeechRecognizer, (void**)speechrecognizer);
+    ISpeechRecognizer_Release(&impl->ISpeechRecognizer_iface);
+
+    return hr;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_create_default(IInspectable **inspectable)
+{
+    TRACE("inspectable %p stub!\n", inspectable);
+
+    return speech_recognizer_create(NULL, (ISpeechRecognizer**)inspectable);
+}
+
+/*
+ *
+ * ActivationFactory for Windows.Media.SpeechRecognition.SpeechRecognizer
+ *
+ */
+
+struct activation_factory
+{
+    IActivationFactory IActivationFactory_iface;
+    ISpeechRecognizerFactory ISpeechRecognizerFactory_iface;
+    ISpeechRecognizerStatics ISpeechRecognizerStatics_iface;
+    ISpeechRecognizerStatics2 ISpeechRecognizerStatics2_iface;
+    LONG ref;
+};
+
+/*
+ *
+ * IActivationFactory
+ *
+ */
+
+static inline struct activation_factory *impl_from_IActivationFactory(IActivationFactory *iface)
+{
+    return CONTAINING_RECORD(iface, struct activation_factory, IActivationFactory_iface);
+}
+
+static HRESULT STDMETHODCALLTYPE activation_factory_QueryInterface(
+    IActivationFactory *iface, REFIID iid, void **out)
+{
+    struct activation_factory *impl = impl_from_IActivationFactory(iface);
+
+    TRACE("iface %p, iid %s, out %p stub!\n", iface, debugstr_guid(iid), out);
+
+    if (IsEqualGUID(iid, &IID_IUnknown) ||
+        IsEqualGUID(iid, &IID_IInspectable) ||
+        IsEqualGUID(iid, &IID_IAgileObject) ||
+        IsEqualGUID(iid, &IID_IActivationFactory))
+    {
+        IUnknown_AddRef(iface);
+        *out = iface;
+        return S_OK;
+    }
+
+    if (IsEqualGUID(iid, &IID_ISpeechRecognizerFactory))
+    {
+        IUnknown_AddRef(iface);
+        *out = &impl->ISpeechRecognizerFactory_iface;
+        return S_OK;
+    }
+
+    if (IsEqualGUID(iid, &IID_ISpeechRecognizerStatics))
+    {
+        IUnknown_AddRef(iface);
+        *out = &impl->ISpeechRecognizerStatics_iface;
+        return S_OK;
+    }
+
+    if (IsEqualGUID(iid, &IID_ISpeechRecognizerStatics2))
+    {
+        IUnknown_AddRef(iface);
+        *out = &impl->ISpeechRecognizerStatics2_iface;
+        return S_OK;
+    }
+
+    FIXME("%s not implemented, returning E_NOINTERFACE.\n", debugstr_guid(iid));
+    *out = NULL;
+    return E_NOINTERFACE;
+}
+
+static ULONG STDMETHODCALLTYPE activation_factory_AddRef(
+    IActivationFactory *iface)
+{
+    struct activation_factory *impl = impl_from_IActivationFactory(iface);
+
+    ULONG ref = InterlockedIncrement(&impl->ref);
+    TRACE("iface %p, ref %u.\n", iface, ref);
+
+    return ref;
+}
+
+static ULONG STDMETHODCALLTYPE activation_factory_Release(
+    IActivationFactory *iface)
+{
+    struct activation_factory *impl = impl_from_IActivationFactory(iface);
+
+    ULONG ref = InterlockedDecrement(&impl->ref);
+    TRACE("iface %p, ref %u.\n", iface, ref);
+
+    return ref;
+}
+
+static HRESULT STDMETHODCALLTYPE activation_factory_GetIids(
+    IActivationFactory *iface, ULONG *iid_count, IID **iids)
+{
+    FIXME("iface %p, iid_count %p, iids %p stub!\n", iface, iid_count, iids);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE activation_factory_GetRuntimeClassName(
+    IActivationFactory *iface, HSTRING *class_name)
+{
+    FIXME("iface %p, class_name %p stub!\n", iface, class_name);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE activation_factory_GetTrustLevel(
+    IActivationFactory *iface, TrustLevel *trust_level)
+{
+    FIXME("iface %p, trust_level %p stub!\n", iface, trust_level);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE activation_factory_ActivateInstance(
+    IActivationFactory *iface, IInspectable **instance)
+{
+    TRACE("iface %p, instance %p\n", iface, instance);
+
+    if (!instance)
+        return E_INVALIDARG;
+
+    return speech_recognizer_create_default(instance);
+}
+
+static const struct IActivationFactoryVtbl activation_factory_vtbl =
+{
+        /* IUnknown methods */
+        activation_factory_QueryInterface,
+        activation_factory_AddRef,
+        activation_factory_Release,
+        /* IInspectable methods */
+        activation_factory_GetIids,
+        activation_factory_GetRuntimeClassName,
+        activation_factory_GetTrustLevel,
+        /* IActivationFactory methods */
+        activation_factory_ActivateInstance,
+};
+
+/*
+ *
+ * ISpeechRecognizerFactory
+ *
+ */
+
+static inline struct activation_factory *impl_from_ISpeechRecognizerFactory(ISpeechRecognizerFactory *iface)
+{
+    return CONTAINING_RECORD(iface, struct activation_factory, ISpeechRecognizerFactory_iface);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_factory_QueryInterface(
+    ISpeechRecognizerFactory *iface, REFIID iid, void **out)
+{
+    struct activation_factory *impl = impl_from_ISpeechRecognizerFactory(iface);
+
+    TRACE("iface %p, iid %s, out %p.\n", iface, debugstr_guid(iid), out);
+
+    /* IUnknown_QueryInterface already defined by IActivationFactory_iface. Redirect there. */
+    return IActivationFactory_QueryInterface(&impl->IActivationFactory_iface, iid, out);
+}
+
+static ULONG STDMETHODCALLTYPE speech_recognizer_factory_AddRef(
+    ISpeechRecognizerFactory *iface)
+{
+    struct activation_factory *impl = impl_from_ISpeechRecognizerFactory(iface);
+
+    TRACE("iface %p.\n", iface);
+
+    /* IUnknown_AddRef already defined by IActivationFactory_iface. Redirect there. */
+    return IActivationFactory_AddRef(&impl->IActivationFactory_iface);
+}
+
+static ULONG STDMETHODCALLTYPE speech_recognizer_factory_Release(
+    ISpeechRecognizerFactory *iface)
+{
+    struct activation_factory *impl = impl_from_ISpeechRecognizerFactory(iface);
+
+    TRACE("iface %p.\n", iface);
+
+    /* IUnknown_Release already defined by IActivationFactory_iface. Redirect there. */
+    return IActivationFactory_Release(&impl->IActivationFactory_iface);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_factory_GetIids(
+    ISpeechRecognizerFactory *iface, ULONG *iid_count, IID **iids)
+{
+    struct activation_factory *impl = impl_from_ISpeechRecognizerFactory(iface);
+
+    TRACE("iface %p, iid_count %p, iids %p.\n", iface, iid_count, iids);
+
+    /* IInspectable_GetIids already defined by ISpeechRecognizer_iface. Redirect there. */
+    return IActivationFactory_GetIids(&impl->IActivationFactory_iface, iid_count, iids);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_factory_GetRuntimeClassName(
+    ISpeechRecognizerFactory *iface, HSTRING *class_name)
+{
+    struct activation_factory *impl = impl_from_ISpeechRecognizerFactory(iface);
+
+    TRACE("iface %p, class_name %p.\n", iface, class_name);
+
+    /* IInspectable_GetRuntimeClassName already defined by IActivationFactory_iface. Redirect there. */
+    return IActivationFactory_GetRuntimeClassName(&impl->IActivationFactory_iface, class_name);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_factory_GetTrustLevel(
+    ISpeechRecognizerFactory *iface, TrustLevel *trust_level)
+{
+    struct activation_factory *impl = impl_from_ISpeechRecognizerFactory(iface);
+
+    TRACE("iface %p, trust_level %p.\n", iface, trust_level);
+
+    /* IInspectable_GetTrustLevel already defined by IActivationFactory_iface. Redirect there. */
+    return IActivationFactory_GetTrustLevel(&impl->IActivationFactory_iface, trust_level);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_factory_Create(
+    ISpeechRecognizerFactory *iface,
+    ILanguage *language,
+    ISpeechRecognizer **speechrecognizer)
+{
+    TRACE("iface %p, language %p, speechrecognizer %p.\n", iface, language, speechrecognizer);
+
+    return speech_recognizer_create(language, speechrecognizer);
+}
+
+static const struct ISpeechRecognizerFactoryVtbl speech_recognizer_factory_vtbl =
+{
+        /* IUnknown methods */
+        speech_recognizer_factory_QueryInterface,
+        speech_recognizer_factory_AddRef,
+        speech_recognizer_factory_Release,
+        /* IInspectable methods */
+        speech_recognizer_factory_GetIids,
+        speech_recognizer_factory_GetRuntimeClassName,
+        speech_recognizer_factory_GetTrustLevel,
+        /* ISpeechRecognizerFactory methods */
+        speech_recognizer_factory_Create
+};
+
+/*
+ *
+ * ISpeechRecognizerStatics
+ *
+ */
+
+static inline struct activation_factory *impl_from_ISpeechRecognizerStatics(ISpeechRecognizerStatics *iface)
+{
+    return CONTAINING_RECORD(iface, struct activation_factory, ISpeechRecognizerStatics_iface);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_statics_QueryInterface(
+    ISpeechRecognizerStatics *iface, REFIID iid, void **out)
+{
+    struct activation_factory *impl = impl_from_ISpeechRecognizerStatics(iface);
+
+    TRACE("iface %p, iid %s, out %p.\n", iface, debugstr_guid(iid), out);
+
+    /* IUnknown_QueryInterface already defined by IActivationFactory_iface. Redirect there. */
+    return IActivationFactory_QueryInterface(&impl->IActivationFactory_iface, iid, out);
+}
+
+static ULONG STDMETHODCALLTYPE speech_recognizer_statics_AddRef(
+    ISpeechRecognizerStatics *iface)
+{
+    struct activation_factory *impl = impl_from_ISpeechRecognizerStatics(iface);
+
+    TRACE("iface %p.\n", iface);
+
+    /* IUnknown_AddRef already defined by IActivationFactory_iface. Redirect there. */
+    return IActivationFactory_AddRef(&impl->IActivationFactory_iface);
+}
+
+static ULONG STDMETHODCALLTYPE speech_recognizer_statics_Release(
+    ISpeechRecognizerStatics *iface)
+{
+    struct activation_factory *impl = impl_from_ISpeechRecognizerStatics(iface);
+
+    TRACE("iface %p.\n", iface);
+
+    /* IUnknown_Release already defined by IActivationFactory_iface. Redirect there. */
+    return IActivationFactory_Release(&impl->IActivationFactory_iface);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_statics_GetIids(
+    ISpeechRecognizerStatics *iface, ULONG *iid_count, IID **iids)
+{
+    struct activation_factory *impl = impl_from_ISpeechRecognizerStatics(iface);
+
+    TRACE("iface %p, iid_count %p, iids %p.\n", iface, iid_count, iids);
+
+    /* IInspectable_GetIids already defined by ISpeechRecognizer_iface. Redirect there. */
+    return IActivationFactory_GetIids(&impl->IActivationFactory_iface, iid_count, iids);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_statics_GetRuntimeClassName(
+    ISpeechRecognizerStatics *iface, HSTRING *class_name)
+{
+    struct activation_factory *impl = impl_from_ISpeechRecognizerStatics(iface);
+
+    TRACE("iface %p, class_name %p.\n", iface, class_name);
+
+    /* IInspectable_GetRuntimeClassName already defined by IActivationFactory_iface. Redirect there. */
+    return IActivationFactory_GetRuntimeClassName(&impl->IActivationFactory_iface, class_name);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_statics_GetTrustLevel(
+    ISpeechRecognizerStatics *iface, TrustLevel *trust_level)
+{
+    struct activation_factory *impl = impl_from_ISpeechRecognizerStatics(iface);
+
+    TRACE("iface %p, trust_level %p.\n", iface, trust_level);
+
+    /* IInspectable_GetTrustLevel already defined by IActivationFactory_iface. Redirect there. */
+    return IActivationFactory_GetTrustLevel(&impl->IActivationFactory_iface, trust_level);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_statics_get_SystemSpeechLanguage(
+    ISpeechRecognizerStatics *iface, ILanguage **language)
+{
+    FIXME("iface %p, language %p stub!\n", iface, language);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_statics_get_SupportedTopicLanguages(
+    ISpeechRecognizerStatics *iface, IVectorView_Language **languages)
+{
+    FIXME("iface %p, languages %p stub!\n", iface, languages);
+    return E_NOTIMPL;
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_statics_get_SupportedGrammarLanguages(
+    ISpeechRecognizerStatics *iface, IVectorView_Language **languages)
+{
+    FIXME("iface %p, languages %p stub!\n", iface, languages);
+    return E_NOTIMPL;
+}
+
+static const struct ISpeechRecognizerStaticsVtbl speech_recognizer_statics_vtbl =
+{
+        /* IUnknown methods */
+        speech_recognizer_statics_QueryInterface,
+        speech_recognizer_statics_AddRef,
+        speech_recognizer_statics_Release,
+        /* IInspectable methods */
+        speech_recognizer_statics_GetIids,
+        speech_recognizer_statics_GetRuntimeClassName,
+        speech_recognizer_statics_GetTrustLevel,
+        /* ISpeechRecognizerStatics2 methods */
+        speech_recognizer_statics_get_SystemSpeechLanguage,
+        speech_recognizer_statics_get_SupportedTopicLanguages,
+        speech_recognizer_statics_get_SupportedGrammarLanguages
+};
+
+/*
+ *
+ * ISpeechRecognizerStatics2
+ *
+ */
+
+static inline struct activation_factory *impl_from_ISpeechRecognizerStatics2(ISpeechRecognizerStatics2 *iface)
+{
+    return CONTAINING_RECORD(iface, struct activation_factory, ISpeechRecognizerStatics2_iface);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_statics2_QueryInterface(
+    ISpeechRecognizerStatics2 *iface, REFIID iid, void **out)
+{
+    struct activation_factory *impl = impl_from_ISpeechRecognizerStatics2(iface);
+
+    TRACE("iface %p, iid %s, out %p stub!\n", iface, debugstr_guid(iid), out);
+
+    /* IUnknown_QueryInterface already defined by IActivationFactory_iface. Redirect there. */
+    return IActivationFactory_QueryInterface(&impl->IActivationFactory_iface, iid, out);
+}
+
+static ULONG STDMETHODCALLTYPE speech_recognizer_statics2_AddRef(
+    ISpeechRecognizerStatics2 *iface)
+{
+    struct activation_factory *impl = impl_from_ISpeechRecognizerStatics2(iface);
+
+    TRACE("iface %p\n", iface);
+
+    /* IUnknown_AddRef already defined by IActivationFactory_iface. Redirect there. */
+    return IActivationFactory_AddRef(&impl->IActivationFactory_iface);
+}
+
+static ULONG STDMETHODCALLTYPE speech_recognizer_statics2_Release(
+    ISpeechRecognizerStatics2 *iface)
+{
+    struct activation_factory *impl = impl_from_ISpeechRecognizerStatics2(iface);
+
+    TRACE("iface %p\n", iface);
+
+    /* IUnknown_Release already defined by IActivationFactory_iface. Redirect there. */
+    return IActivationFactory_Release(&impl->IActivationFactory_iface);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_statics2_GetIids(
+    ISpeechRecognizerStatics2 *iface, ULONG *iid_count, IID **iids)
+{
+    struct activation_factory *impl = impl_from_ISpeechRecognizerStatics2(iface);
+
+    TRACE("iface %p, iid_count %p, iids %p stub!\n", iface, iid_count, iids);
+
+    /* IInspectable_GetIids already defined by ISpeechRecognizer_iface. Redirect there. */
+    return IActivationFactory_GetIids(&impl->IActivationFactory_iface, iid_count, iids);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_statics2_GetRuntimeClassName(
+    ISpeechRecognizerStatics2 *iface, HSTRING *class_name)
+{
+    struct activation_factory *impl = impl_from_ISpeechRecognizerStatics2(iface);
+
+    TRACE("iface %p, class_name %p stub!\n", iface, class_name);
+
+    /* IInspectable_GetRuntimeClassName already defined by IActivationFactory_iface. Redirect there. */
+    return IActivationFactory_GetRuntimeClassName(&impl->IActivationFactory_iface, class_name);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_statics2_GetTrustLevel(
+    ISpeechRecognizerStatics2 *iface, TrustLevel *trust_level)
+{
+    struct activation_factory *impl = impl_from_ISpeechRecognizerStatics2(iface);
+
+    TRACE("iface %p, trust_level %p stub!\n", iface, trust_level);
+
+    /* IInspectable_GetTrustLevel already defined by IActivationFactory_iface. Redirect there. */
+    return IActivationFactory_GetTrustLevel(&impl->IActivationFactory_iface, trust_level);
+}
+
+static HRESULT STDMETHODCALLTYPE speech_recognizer_statics2_TrySetSystemSpeechLanguageAsync(
+    ISpeechRecognizerStatics2 *iface, ILanguage *language, IAsyncOperation_boolean **operation)
+{
+    FIXME("iface %p, operation %p stub!\n", iface, operation);
+    return E_NOTIMPL;
+}
+
+static const struct ISpeechRecognizerStatics2Vtbl speech_recognizer_statics2_vtbl =
+{
+        /* IUnknown methods */
+        speech_recognizer_statics2_QueryInterface,
+        speech_recognizer_statics2_AddRef,
+        speech_recognizer_statics2_Release,
+        /* IInspectable methods */
+        speech_recognizer_statics2_GetIids,
+        speech_recognizer_statics2_GetRuntimeClassName,
+        speech_recognizer_statics2_GetTrustLevel,
+        /* ISpeechRecognizerStatics2 methods */
+        speech_recognizer_statics2_TrySetSystemSpeechLanguageAsync,
+};
+
+/*
+ *
+ * ActivationFactory instance
+ *
+ */
+
+static struct activation_factory speechrecognizer_af =
+{
+    .IActivationFactory_iface = {&activation_factory_vtbl},
+    .ISpeechRecognizerFactory_iface = {&speech_recognizer_factory_vtbl},
+    .ISpeechRecognizerStatics_iface = {&speech_recognizer_statics_vtbl},
+    .ISpeechRecognizerStatics2_iface = {&speech_recognizer_statics2_vtbl},
+    .ref = 1
+};
+
+void STDMETHODCALLTYPE speech_recognizer_get_activation_factory(IActivationFactory **factory)
+{
+    *factory = &speechrecognizer_af.IActivationFactory_iface;
+}
diff --git a/dlls/windows.media.speech/tests/speech.c b/dlls/windows.media.speech/tests/speech.c
index 3e349cf107a..745c9277feb 100644
--- a/dlls/windows.media.speech/tests/speech.c
+++ b/dlls/windows.media.speech/tests/speech.c
@@ -29,6 +29,8 @@
 #define WIDL_using_Windows_Foundation
 #define WIDL_using_Windows_Foundation_Collections
 #include "windows.foundation.h"
+#define WIDL_using_Windows_Globalization
+#include "windows.globalization.h"
 #define WIDL_using_Windows_Media_SpeechRecognition
 #include "windows.media.speechrecognition.h"
 #define WIDL_using_Windows_Media_SpeechSynthesis
@@ -40,6 +42,15 @@
 
 HRESULT WINAPI (*pDllGetActivationFactory)(HSTRING, IActivationFactory **);
 
+static inline const char *debugstr_hstring(HSTRING hstr)
+{
+    const WCHAR *str;
+    UINT32 len;
+    if (hstr && !((ULONG_PTR)hstr >> 16)) return "(invalid)";
+    str = WindowsGetStringRawBuffer(hstr, &len);
+    return wine_dbgstr_wn(str, len);
+}
+
 static void test_ActivationFactory(void)
 {
     static const WCHAR *speech_synthesizer_name = L"Windows.Media.SpeechSynthesis.SpeechSynthesizer";
@@ -86,7 +97,7 @@ static void test_ActivationFactory(void)
     ok(afactory == afactory2 && afactory == afactory3 && afactory2 == afactory3, "Factories didn't point at the same memory!");
 
     hr = RoGetActivationFactory(str2, &IID_IActivationFactory, (void **)&afactory4);
-    todo_wine ok(hr == S_OK || broken(hr == REGDB_E_CLASSNOTREG), "RoGetActivationFactory failed, hr %#x.\n", hr);
+    ok(hr == S_OK || broken(hr == REGDB_E_CLASSNOTREG), "RoGetActivationFactory failed, hr %#x.\n", hr);
 
     if(hr == S_OK) /* Win10+ only */
     {
@@ -300,9 +311,117 @@ static void test_VoiceInformation(void)
     RoUninitialize();
 }
 
+static void test_SpeechRecognizer(void)
+{
+    static const WCHAR *speech_recognition_name = L"Windows.Media.SpeechRecognition.SpeechRecognizer";
+    ISpeechRecognizerFactory *sr_factory = NULL;
+    ISpeechRecognizerStatics *sr_statics = NULL;
+    ISpeechRecognizerStatics2 *sr_statics2 = NULL;
+    ISpeechRecognizer *recognizer = NULL;
+    ISpeechRecognizer2 *recognizer2 = NULL;
+    IActivationFactory *factory = NULL;
+    IInspectable *inspectable = NULL;
+    IClosable *closable = NULL;
+    ILanguage *language = NULL;
+    HSTRING hstr, hstr_lang;
+    HRESULT hr;
+    LONG ref;
+
+    trace("Running test_SpeechRecognizer\n");
+
+    hr = RoInitialize(RO_INIT_MULTITHREADED);
+    ok(hr == S_OK, "RoInitialize failed, hr %#x.\n", hr);
+
+    hr = WindowsCreateString(speech_recognition_name, wcslen(speech_recognition_name), &hstr);
+    ok(hr == S_OK, "WindowsCreateString failed, hr %#x.n", hr);
+
+    hr = RoGetActivationFactory(hstr, &IID_IActivationFactory, (void **)&factory);
+    ok(hr == S_OK || broken(hr == REGDB_E_CLASSNOTREG), "RoGetActivationFactory failed, hr %#x.\n", hr);
+
+    if(hr == REGDB_E_CLASSNOTREG) /* Win 8 and 8.1 */
+    {
+        win_skip("SpeechRecognizer activation factory not available!\n");
+        goto done;
+    }
+
+    hr = IActivationFactory_QueryInterface(factory, &IID_ISpeechRecognizerFactory, (void **)&sr_factory);
+    ok(hr == S_OK, "IActivationFactory_QueryInterface IID_ISpeechRecognizer failed, hr %#x.\n", hr);
+
+    hr = IActivationFactory_QueryInterface(factory, &IID_ISpeechRecognizerStatics, (void **)&sr_statics);
+    ok(hr == S_OK, "IActivationFactory_QueryInterface IID_ISpeechRecognizerStatics failed, hr %#x.\n", hr);
+
+    hr = ISpeechRecognizerStatics_get_SystemSpeechLanguage(sr_statics, &language);
+    todo_wine ok(hr == S_OK, "ISpeechRecognizerStatics_SystemSpeechLanguage failed, hr %#x.\n", hr);
+
+    if(hr == S_OK)
+    {
+        hr = ILanguage_get_DisplayName(language, &hstr_lang);
+        ok(hr == S_OK, "ILanguage_DisplayName failed, hr %#x.\n", hr);
+
+        trace("SpeechRecognizer default language %s.\n", debugstr_hstring(hstr_lang));
+
+        ILanguage_Release(language);
+    }
+
+    ref = ISpeechRecognizerStatics_Release(sr_statics);
+    ok(ref == 3, "Got unexpected ref %u.\n", ref);
+
+    hr = IActivationFactory_QueryInterface(factory, &IID_ISpeechRecognizerStatics2, (void **)&sr_statics2);
+    ok(hr == S_OK || broken(hr == E_NOINTERFACE), "IActivationFactory_QueryInterface IID_ISpeechRecognizerStatics2 failed, hr %#x.\n", hr);
+
+    if(hr == S_OK) /* SpeechRecognizerStatics2 not implemented on Win10 1507 */
+    {
+        ref = ISpeechRecognizerStatics2_Release(sr_statics2);
+        ok(ref == 3, "Got unexpected ref %u.\n", ref);
+    }
+
+    ref = ISpeechRecognizerFactory_Release(sr_factory);
+    ok(ref == 2, "Got unexpected ref %u.\n", ref);
+    
+    ref = IActivationFactory_Release(factory);
+    ok(ref == 1, "Got unexpected ref %u.\n", ref);
+
+    hr = RoActivateInstance(hstr, &inspectable);
+    ok(hr == S_OK || broken(hr == 0x800455a0), "Got unexpected hr %#x.\n", hr);
+
+    if(hr == S_OK)
+    {
+        hr = IInspectable_QueryInterface(inspectable, &IID_ISpeechRecognizer, (void **)&recognizer);
+        ok(hr == S_OK, "Got unexpected hr %#x.\n", hr);
+
+        hr = IInspectable_QueryInterface(inspectable, &IID_ISpeechRecognizer2, (void **)&recognizer2);
+        ok(hr == S_OK, "Got unexpected hr %#x.\n", hr);
+
+        hr = IInspectable_QueryInterface(inspectable, &IID_IClosable, (void **)&closable);
+        ok(hr == S_OK, "Got unexpected hr %#x.\n", hr);
+
+        ref = IClosable_Release(closable);
+        ok(ref == 3, "Got unexpected ref %u.\n", ref);
+
+        ref = ISpeechRecognizer2_Release(recognizer2);
+        ok(ref == 2, "Got unexpected ref %u.\n", ref);
+
+        ref = ISpeechRecognizer_Release(recognizer);
+        ok(ref == 1, "Got unexpected ref %u.\n", ref);
+
+        ref = IInspectable_Release(inspectable);
+        ok(!ref, "Got unexpected ref %u.\n", ref);
+    }
+    else if(hr == 0x800455a0) /* Not sure what this hr is... Probably if a language pack is not installed. */
+    {
+        win_skip("Could not init SpeechRecognizer with default language!\n");
+    }
+
+done:
+    WindowsDeleteString(hstr);
+
+    RoUninitialize();
+}
+
 START_TEST(speech)
 {
     test_ActivationFactory();
     test_SpeechSynthesizer();
     test_VoiceInformation();
+    test_SpeechRecognizer();
 }
diff --git a/dlls/windows.media.speech/windows_media_speech_private.h b/dlls/windows.media.speech/windows_media_speech_private.h
index 441d95b3e5d..b25002b2cbc 100644
--- a/dlls/windows.media.speech/windows_media_speech_private.h
+++ b/dlls/windows.media.speech/windows_media_speech_private.h
@@ -44,6 +44,8 @@
 #include "windows.globalization.h"
 #define WIDL_using_Windows_Media_SpeechSynthesis
 #include "windows.media.speechsynthesis.h"
+#define WIDL_using_Windows_Media_SpeechRecognition
+#include "windows.media.speechrecognition.h"
 
 #define IsEqualClassID(classid1, classid2) (!wcscmp(classid1, classid2))
 
@@ -56,6 +58,14 @@ static inline const char *debugstr_hstring(HSTRING hstr)
     return wine_dbgstr_wn(str, len);
 }
 
+/*
+ *
+ * Windows.Media.SpeechRecognition
+ *
+ */
+
+void STDMETHODCALLTYPE speech_recognizer_get_activation_factory(IActivationFactory **factory) DECLSPEC_HIDDEN;
+
 /*
  *
  * Windows.Media.SpeechSynthesis
-- 
2.34.1

